name: Deploy Smart Contract (BSC Testnet)

on:
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Create all project files on the runner (avoids repo setup issues)
      - name: Create folders
        run: |
          mkdir -p contracts scripts

      - name: Write contract
        run: |
          cat > contracts/ShopPass.sol <<'EOF'
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;
import "https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v5.0.2/contracts/token/ERC721/extensions/ERC721Enumerable.sol";
import "https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v5.0.2/contracts/access/Ownable.sol";

contract ShopPass is ERC721Enumerable, Ownable {
    enum Tier { Common, Uncommon, Rare, Epic, Legendary }
    uint256 public constant MAX_SUPPLY = 10000;
    uint256 public nextId;
    bool public saleActive = true;
    mapping(uint256 => Tier) public tierOf;
    mapping(address => bool) public minted;

    constructor() ERC721("Sahabel Classic Fashion NFT", "SCFNFT") Ownable(msg.sender) {}

    function mintPublic() external {
        require(saleActive, "Minting is not active");
        require(!minted[msg.sender], "Already minted");
        require(nextId < MAX_SUPPLY, "Sold out");
        uint256 tokenId = nextId++;
        minted[msg.sender] = true;
        _safeMint(msg.sender, tokenId);
        uint256 r = uint256(keccak256(abi.encodePacked(blockhash(block.number - 1), msg.sender, tokenId))) % 10000;
        if (r < 2000) tierOf[tokenId] = Tier.Common;
        else if (r < 4000) tierOf[tokenId] = Tier.Uncommon;
        else if (r < 6000) tierOf[tokenId] = Tier.Rare;
        else if (r < 8000) tierOf[tokenId] = Tier.Epic;
        else tierOf[tokenId] = Tier.Legendary;
    }

    function walletHighestTier(address user) external view returns (bool has, Tier highest) {
        uint256 n = balanceOf(user);
        if (n == 0) return (false, Tier.Common);
        Tier maxTier = Tier.Common;
        for (uint256 i = 0; i < n; i++) {
            uint256 id = tokenOfOwnerByIndex(user, i);
            Tier t = tierOf[id];
            if (uint(t) > uint(maxTier)) maxTier = t;
        }
        return (true, maxTier);
    }

    function setSaleActive(bool active) external onlyOwner { saleActive = active; }
}
EOF

      - name: Write deploy script
        run: |
          cat > scripts/deploy.js <<'EOF'
const hre = require("hardhat");
const fs = require("fs");
async function main() {
  await hre.run("compile");
  const ShopPass = await hre.ethers.getContractFactory("ShopPass");
  const contract = await ShopPass.deploy();
  await contract.waitForDeployment();
  const address = await contract.getAddress();
  console.log("âœ… Deployed ShopPass at:", address);
  const art = JSON.parse(fs.readFileSync("./artifacts/contracts/ShopPass.sol/ShopPass.json","utf8"));
  const out = { address, abi: art.abi, network: hre.network.name, chainId: hre.network.config.chainId, deployedAt: new Date().toISOString() };
  fs.writeFileSync("deployment-output.json", JSON.stringify(out,null,2));
  console.log("ðŸ“„ Wrote deployment-output.json");
}
main().catch((e)=>{ console.error(e); process.exit(1); });
EOF

      - name: Write hardhat config and package.json
        run: |
          cat > hardhat.config.js <<'EOF'
require("@nomicfoundation/hardhat-toolbox");
const RPC_URL = process.env.RPC_URL || "";
const PK = process.env.DEPLOYER_PRIVATE_KEY || "";
module.exports = {
  solidity: { version: "0.8.20", settings: { optimizer: { enabled: true, runs: 200 } } },
  networks: { bscTestnet: { url: RPC_URL, chainId: 97, accounts: PK ? [PK] : [] } },
};
EOF
          cat > package.json <<'EOF'
{
  "name": "scfnft-deploy",
  "private": true,
  "scripts": {
    "compile": "hardhat compile",
    "deploy:bscTestnet": "hardhat run scripts/deploy.js --network bscTestnet"
  },
  "devDependencies": {
    "@nomicfoundation/hardhat-toolbox": "^4.0.0",
    "hardhat": "^2.22.10"
  }
}
EOF

      - name: Install dependencies
        run: npm ci

      - name: Deploy to BSC Testnet
        env:
          RPC_URL: ${{ secrets.RPC_URL }}
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
        run: npx hardhat run scripts/deploy.js --network bscTestnet

      - name: Upload deployment output
        uses: actions/upload-artifact@v4
        with:
          name: deployment-output
          path: deployment-output.json
